name: Update Combined Economist RSS
on:
  schedule:
    - cron: "0 * * * *"  # Every hour
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            chromium-browser \
            chromium-chromedriver \
            xvfb \
            fonts-liberation \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libatspi2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libwayland-client0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            xdg-utils \
            libasound2t64 || sudo apt-get install -y libasound2 || true
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser beautifulsoup4 lxml undetected-chromedriver
      
      - name: Run combined RSS script
        env:
          PYTHONUNBUFFERED: "1"
          DISPLAY: ":99"
          # Anti-detection environment variables
          CHROME_NO_SANDBOX: "1"
        run: |
          # Start virtual display for Chrome
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 3
          
          # Run the script with timeout (30 minutes max)
          timeout 1800 python lau.py || exit_code=$?
          
          # Check if script completed successfully or timed out
          if [ "${exit_code}" -eq 124 ]; then
            echo "Script timed out after 30 minutes"
            # Still try to commit if there's any output
          elif [ "${exit_code}" -ne 0 ] && [ "${exit_code}" -ne "" ]; then
            echo "Script failed with exit code ${exit_code}"
            exit 1
          fi
      
      - name: Check if RSS file was generated
        run: |
          if [ -f combined.xml ]; then
            echo "✓ RSS file generated successfully"
            echo "File size: $(stat -f%z combined.xml 2>/dev/null || stat -c%s combined.xml) bytes"
            echo "Number of items: $(grep -c '<item>' combined.xml || echo 0)"
          else
            echo "❌ RSS file not found"
            exit 1
          fi
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add combined.xml
          
          # Also add debug files if they exist (for troubleshooting)
          git add debug_*.html 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update combined Economist RSS [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]"
            git push
          fi
      
      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-files
          path: |
            debug_*.html
            *.log
          retention-days: 7
          if-no-files-found: ignore
